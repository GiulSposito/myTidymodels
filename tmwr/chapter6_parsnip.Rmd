---
title: "Modeling wigh Parsnip"
output: 
  md_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

# Data - Training and Testing Sets

```{r}
library(tidyverse) # eda and transformation
library(tidymodels)
theme_set(theme_light())

# load data from modeldata package
data(ames, package="modeldata")
ames <- ames %>% mutate(Sale_Price = log10(Sale_Price))

# traning and testing subset
set.seed(1975)
ames_split <- initial_split(ames, prop = 0.80, strata = Sale_Price)
ames_train <- training(ames_split)
ames_test  <-  testing(ames_split)


```

# Creating Models

```{r, warning=FALSE}
library(tidymodels)
tidymodels_prefer()

# linear regressions

# with lm: ordinary LM
linear_reg() |> 
  set_engine("lm")

# with glmnet: regularized linear regression
linear_reg() |> 
  set_engine("glmnet")

# with rstanarm: bayesian regularization
linear_reg() |>  
  set_engine("stan")
```

## Convert to package sintaxe

`translate()` provides the original package`s sintax code

```{r}

# with lm: ordinary LM
linear_reg() |> 
  set_engine("lm") |> 
  translate()

# with glmnet: regularized linear regression
linear_reg(penalty = 1) |> 
  set_engine("glmnet") |> 
  translate()

# with rstanarm: bayesian regularization
linear_reg() |>  
  set_engine("stan") |> 
  translate()
```
 
Note the `missing_arg()` placeholder!!

# Fit interface

```{r}

lm_model <- linear_reg() |> 
  set_engine("lm")

# formula format
lm_form_fit <- 
  lm_model |> 
  fit(Sale_Price ~ Longitude + Latitude, data=ames_train)

lm_form_fit

# formula format
lm_xy_fit <-
  lm_model |>
  fit_xy(x = select(ames_train, Longitude, Latitude),
         y = pull(ames_train, Sale_Price)) 


lm_xy_fit
```

# Parsnip Argument Consistency

```{r}

rand_forest(trees=1000, min_n=5) |> 
  set_engine("ranger") |> 
  set_mode("regression") |> 
  translate()

```

Note: `trees` becames `num.tree`, `min_n` becames `min.node.size`.


```{r}

rand_forest(trees=1000, min_n=5) |> 
  set_engine("randomForest") |> 
  set_mode("regression") |> 
  translate()

```

Note: `trees` becames `ntree`, `min_n` becames `nodesize`.

Modeling functions in parsnip separate model arguments into two categories:

. Main arguments are more commonly used and tend to be available across engines.
. Engine arguments are either specific to a particular engine or used more rarely.

`verbose=T` is one case of that

```{r}
rand_forest(trees=1000, min_n=5) |> 
  set_engine("ranger", verbose=T) |> 
  set_mode("regression")
```

# Model Results

```{r}
lm_model <- lm_form_fit |> 
  extract_fit_engine()

lm_model
lm_model |> summary()
lm_model |> vcov()

par(mfrow = c(2, 2))
lm_model |> plot()
```

## Broom Tidy

Model coefs and attributes direct from `Parsnip` object

```{r}
lm_form_fit |> tidy()
lm_form_fit |> glance()
```

# Make Predictions

Another area where parsnip diverges from conventional R modeling functions is the format of values returned from predict(). For predictions, parsnip always conforms to the following rules:

. The results are always a tibble.
. The column names of the tibble are always predictable.
. There are always as many rows in the tibble as there are in the input data set.

For example, when numeric data are predicted:

```{r}
ames_small <- 
  ames_test |> 
  sample_n(5)

ames_small |> 
  predict(lm_form_fit, new_data=_)

```

The row order of the predictions are always the same as the original data. These three rules make it easier to merge predictions with the original data:

```{r}

bind_cols(
  select(ames_small, Sale_Price),
  predict(lm_form_fit, new_data=ames_small),
  predict(lm_form_fit, new_data=ames_small, type="pred_int")
)

```

Using the standard code interface.

```{r}
tree_model <- 
  decision_tree(min_n=3) |> 
  set_engine("rpart") |> 
  set_mode("regression")

tree_model

tree_fit <- 
  tree_model |> 
  fit(Sale_Price ~ Longitude + Latitude, data=ames_train)

tree_fit

bind_cols(
  select(ames_small, Sale_Price),
  predict(tree_fit, new_data=ames_small)
)

```

Use `parsnip_addin()` to shortcut engine especification!!

# Reference

All code and text came from Max Kuhn and Julia Silge`s book [Tidy Modeling with R](https://www.tmwr.org/models).
